# 03 - Mechanic Support Matrix (Exhaustive)

**Generated:** 2026-02-09
**Scope:** End-to-end support for all mechanic types across 8 pipeline stages: Domain Knowledge, Game Design, Scene Architecture, Interaction Design, Asset Generation, Blueprint Assembly, Frontend Component, Frontend State.
**Pipeline:** V3 (5-Phase ReAct Architecture)

---

## Executive Summary

Of the 5 true mechanic types + 1 cross-cutting modifier, only **drag_drop is fully functional end-to-end**. Every other mechanic has gaps ranging from missing upstream data generation to disconnected frontend state. The root cause is architectural: the V3 pipeline was built and tested exclusively on drag_drop, and the tool/schema/state infrastructure for other mechanics exists structurally but was never populated with data or wired to produce working games.

**Key numbers:**
- 5 true mechanics + 1 modifier (hierarchy) defined
- 1/5 fully functional end-to-end (drag_drop)
- 0/5 non-drag_drop mechanics have their upstream data generated by any agent
- 4/5 non-drag_drop mechanics have frontend components that render but cannot complete a game loop
- **52 gaps identified** across all pipeline stages (13 CRITICAL, 16 HIGH, 15 MEDIUM, 8 LOW)

---

## Overview Matrix (8 Pipeline Stages)

| Mechanic | DK Retrieval | Game Design | Scene Arch | Interaction Design | Asset Gen | Blueprint | Frontend UI | Frontend State | E2E |
|---|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| `drag_drop` | FULL | FULL | FULL | FULL | FULL | FULL | FULL | FULL | **WORKING** |
| `click_to_identify` | PARTIAL | PARTIAL | PARTIAL | BROKEN | REUSE | PARTIAL | FULL | FULL | **BROKEN** |
| `trace_path` | PARTIAL | PARTIAL | PARTIAL | BROKEN | GAP | PARTIAL | FULL | PARTIAL | **BROKEN** |
| `sequencing` | PARTIAL | PARTIAL | PARTIAL | BROKEN | N/A | PARTIAL | FULL | LOCAL | **BROKEN** |
| `description_matching` | GAP | PARTIAL | PARTIAL | BROKEN | REUSE | PARTIAL | PARTIAL | DISCONNECTED | **BROKEN** |
| `hierarchy` (modifier) | FULL | FULL | FULL | N/A | PARTIAL | FULL | PARTIAL | PARTIAL | **FUNCTIONAL** |

### Rating Definitions

| Rating | Meaning |
|---|---|
| FULL | Complete, tested, no known gaps |
| PARTIAL | Structure/schema exists but data population or validation is incomplete |
| BROKEN | Stage exists but produces no usable output for this mechanic |
| GAP | No implementation at all for this mechanic at this stage |
| REUSE | Reuses drag_drop assets (intentionally — no separate generation needed) |
| N/A | Stage not applicable to this mechanic |
| LOCAL | Frontend state managed inside component, not centralized store |
| DISCONNECTED | Types defined but not wired to actions/reducers |

---

## Per-Mechanic Deep Dive

### 1. drag_drop

**End-to-End Status: WORKING** — The only fully functional mechanic. All others are measured against this.

| # | Stage | Status | Details | Gaps |
|---|---|---|---|---|
| 1 | DK Retrieval | FULL | `canonical_labels` retrieved; `hierarchical_relationships` for grouping | **G-DD-1**: `canonical_labels` written inside nested `domain_knowledge` dict, not at top-level state. V3 agents read empty `state.get("canonical_labels", [])`. Pipeline works because full domain_knowledge JSON is passed to LLM, but the dedicated field is always `[]`. |
| 2 | Game Design | FULL | `GameDesignV3Slim.labels.zone_labels` populated. `SlimSceneDesign.mechanics[{type:"drag_drop"}]` | **G-DD-2**: No distractor label count limit. Agent could generate 50+ distractors bloating blueprint. |
| 3 | Scene Arch | FULL | `SceneSpecV3.zones[]` with position_hint, description, difficulty. `mechanic_configs[{type:"drag_drop"}]` | **G-DD-3**: Zone IDs generated by LLM, no normalization tool. Pydantic auto-generates from label if malformed, silently overwriting. |
| 4 | Interaction | FULL | `MechanicScoringV3` with standard strategy. `MechanicFeedbackV3` with on_correct/on_incorrect. Misconception feedback generated. | None |
| 5 | Asset Gen | FULL | `search_diagram_image` → `generate_diagram_image` → `detect_zones` produces image + zone coordinates | **G-DD-4**: Zone detection may return fewer zones than labels. Missing zones get placeholder grid positions in repair. **G-DD-5**: Image search may return labeled diagrams despite `prefer_unlabeled` flag. |
| 6 | Blueprint | FULL | Zones with coordinates, labels with correctZoneId, scoring, feedback all populated | **G-DD-6**: `_normalize_coordinates()` doesn't clamp to 0-100% at assembly time (only at repair time). |
| 7 | Frontend UI | FULL | `DraggableLabel` + `DropZone` + `LabelTray` via @dnd-kit | None |
| 8 | Frontend State | FULL | `placedLabels`, `score`, `isComplete` in centralized `useLabelDiagramState` | None |

**Total gaps: 6 (0 CRITICAL, 2 HIGH, 2 MEDIUM, 2 LOW)**

---

### 2. click_to_identify

**End-to-End Status: BROKEN** — Frontend component is complete and properly wired, but **no agent in the pipeline generates identification prompts**. The game cannot start because `identificationPrompts` is always empty.

| # | Stage | Status | Details | Gaps |
|---|---|---|---|---|
| 1 | DK Retrieval | PARTIAL | Labels retrieved (reuse drag_drop). No identification-specific data. | **G-CI-1**: No per-label difficulty hints retrieved. No question-style data for "Click on the X" prompts. Domain knowledge doesn't know this will be a click_to_identify game. |
| 2 | Game Design | PARTIAL | `ClickDesign` schema exists with `prompts: List[str]` field. `VALID_MECHANIC_TYPES` includes `click_to_identify`. | **G-CI-2**: `GameDesignV3Slim` uses `SlimMechanicRef` with only `type` field — no `click_config` or `prompts` at design stage. Full `ClickDesign` exists in non-slim schema but is never populated by game_designer_v3. **G-CI-3**: `validate_design_impl()` doesn't validate that click_to_identify has prompts (slim validation only checks type string). |
| 3 | Scene Arch | PARTIAL | `get_mechanic_config_schema("click_to_identify")` returns config options. System prompt mentions click mechanics. | **G-CI-4**: System prompt documents `mechanic_data` shape for click but agent has no tool to generate prompts. LLM must generate prompts from thin air without a dedicated tool. **G-CI-5**: `validate_scene_spec` doesn't check that click_to_identify has identification prompts in mechanic_data. |
| 4 | Interaction | BROKEN | `get_scoring_templates("click_to_identify")` returns standard scoring. Generic feedback generated. | **G-CI-6** (CRITICAL): `interaction_designer_v3` does NOT generate `identificationPrompts[]`. No tool exists for this. The agent only produces scoring strategy + generic feedback messages. **G-CI-7**: No per-prompt scoring data (all prompts score identically). **G-CI-8**: No prompt ordering by difficulty. |
| 5 | Asset Gen | REUSE | Reuses drag_drop zone coordinates as hotspot positions | None (intentional reuse) |
| 6 | Blueprint | PARTIAL | Mechanic config from game_design extracted if present. Zones available. | **G-CI-9**: `assemble_blueprint_impl` extracts `click_config` from game_design mechanics, but upstream never populates it. Blueprint `identificationPrompts` field is always empty. **G-CI-10**: No validation in `submit_blueprint_impl` that click_to_identify has non-empty identificationPrompts. |
| 7 | Frontend UI | FULL | `HotspotManager.tsx` handles click regions, prompt display, sequential/any_order modes, visual feedback. Properly decoupled with props. | **G-CI-11**: Component gracefully handles empty prompts (renders nothing), but this means game silently does nothing. No error shown to user. |
| 8 | Frontend State | FULL | `IdentificationProgress` tracks `currentPromptIndex`, `completedZoneIds`, `incorrectAttempts`. Actions: `updateIdentificationProgress()`. | None |

**Total gaps: 11 (1 CRITICAL, 4 HIGH, 4 MEDIUM, 2 LOW)**

**Root cause:** No agent generates identification prompts. The `interaction_designer_v3` was designed for scoring/feedback only, not mechanic-specific content generation. Needs either: (a) a `generate_identification_prompts` tool in interaction_designer_v3, or (b) scene_architect_v3 to populate mechanic_data.prompts.

---

### 3. trace_path

**End-to-End Status: BROKEN** — Frontend PathDrawer component exists and handles waypoint visualization, but **no agent generates waypoint coordinates or path connections**. Asset generation has no path-specific tools.

| # | Stage | Status | Details | Gaps |
|---|---|---|---|---|
| 1 | DK Retrieval | PARTIAL | `sequence_flow_data` retrieved with ordered items for process/cycle questions. | **G-TP-1**: `sequence_flow_data` has ordered text items but NO spatial coordinates. Items like "Blood enters right atrium" have no x,y position on the diagram. **G-TP-2**: No path connection data (which node connects to which). Linear ordering assumed but branching/cyclic paths not represented. |
| 2 | Game Design | PARTIAL | `PathDesign` schema exists with `waypoints: List[str]`, `flow_type`, `start_point`, `end_point`. | **G-TP-3**: `GameDesignV3Slim.SlimMechanicRef` has only `type` field — no `path_config` at slim design stage. **G-TP-4**: Full `PathDesign` exists but `game_designer_v3` never populates it (only produces slim output). **G-TP-5**: `validate_design_impl()` doesn't validate trace_path has path_config/waypoints (slim validation only). |
| 3 | Scene Arch | PARTIAL | System prompt documents `mechanic_data: {waypoints: [ordered labels]}` for trace_path. Agent can try to generate waypoint order. | **G-TP-6**: No tool to verify waypoints map to actual zone labels. **G-TP-7**: `validate_scene_spec` doesn't validate waypoint list matches zone labels. **G-TP-8**: No spatial coordinate data for waypoints — only label text order. Path overlay impossible without coordinates. |
| 4 | Interaction | BROKEN | `get_scoring_templates("trace_path")` returns progressive scoring. Generic feedback. | **G-TP-9** (CRITICAL): No waypoint-specific scoring (per-node points, partial path credit). **G-TP-10** (CRITICAL): No path validation data generated (tolerance, snap distance, allowed deviations). **G-TP-11**: No per-waypoint feedback messages. |
| 5 | Asset Gen | GAP | Only drag_drop assets generated (image + zones). | **G-TP-12** (CRITICAL): No `generate_waypoints` tool exists. Cannot map flow_data items to x,y coordinates on the generated image. **G-TP-13** (CRITICAL): No `generate_path_connections` tool exists. Cannot define edges between waypoints. **G-TP-14**: No path overlay generation (SVG path data, canvas coordinates). **G-TP-15**: `submit_assets` doesn't validate waypoint presence for trace_path scenes. |
| 6 | Blueprint | PARTIAL | Blueprint has `paths` field for `TracePath[]` data. Mechanic config extracted if present. | **G-TP-16**: `assemble_blueprint_impl` extracts `path_config` from game_design mechanics, but upstream never populates coordinates. Blueprint `paths` field is always empty or text-only. **G-TP-17**: No canvas overlay spec in blueprint (line color, thickness, snap tolerance). |
| 7 | Frontend UI | FULL | `PathDrawer.tsx` renders SVG lines between waypoints, handles click-to-visit, tracks visited waypoints per path. Multi-path support with auto-advance. | **G-TP-18**: Component expects `TracePath.waypoints` with x,y coordinates — upstream provides only label text. Component renders nothing if waypoints have no coordinates. |
| 8 | Frontend State | PARTIAL | `PathProgress` type defined. `updatePathProgress()` action exists. | **G-TP-19**: `checkModeTransition()` checks `pathProgress.isComplete` but if path data never populated, transition never fires. |

**Total gaps: 19 (4 CRITICAL, 6 HIGH, 6 MEDIUM, 3 LOW)**

**Root cause:** The entire trace_path data pipeline is conceptually different from drag_drop. Drag_drop needs zone positions (where things ARE). Trace_path needs waypoint positions AND connections (where things FLOW). No tool in the V3 pipeline maps flow data to spatial coordinates on the image. Needs: `generate_waypoints` (vision model locates flow items on image) + `generate_path_connections` (deterministic for linear/cyclic, LLM for branching).

---

### 4. sequencing

**End-to-End Status: BROKEN** — Frontend `SequenceBuilder` component is complete with drag-to-reorder and scoring, but **no agent generates sequence items or correct order data**. Component has a label-based fallback that partially works.

| # | Stage | Status | Details | Gaps |
|---|---|---|---|---|
| 1 | DK Retrieval | PARTIAL | `sequence_flow_data` with `SequenceFlowData.steps[]` retrieved for process questions. | **G-SQ-1**: `sequence_flow_data` written inside nested `domain_knowledge` dict. V3 context injection reads empty top-level. **G-SQ-2**: Steps have `text` and `order` but no `description` (educational explanation per step) or `thumbnail_description` for visual items. |
| 2 | Game Design | PARTIAL | `SequenceDesign` schema exists with `items`, `correct_order`, `instruction_text`. | **G-SQ-3**: `GameDesignV3Slim.SlimMechanicRef` has only `type` — no `sequence_config` at slim design stage. **G-SQ-4**: Full `SequenceDesign` exists but game_designer_v3 never populates it. |
| 3 | Scene Arch | PARTIAL | System prompt documents `mechanic_data: {correct_order: [label ids]}` for sequencing. | **G-SQ-5**: No tool to generate sequence items from domain knowledge `sequence_flow_data`. Agent must manually transcribe flow data to sequence items. **G-SQ-6**: `validate_scene_spec` doesn't validate that sequencing mechanic has `correct_order` in mechanic_data. |
| 4 | Interaction | BROKEN | `get_scoring_templates("sequencing")` returns progressive scoring. Generic feedback. | **G-SQ-7** (CRITICAL): No sequence-specific scoring generated (per-item points, order sensitivity, partial credit formula). **G-SQ-8**: No per-step feedback messages generated (e.g., "Step 3 comes before Step 4 because..."). |
| 5 | Asset Gen | N/A | Sequencing is text-based. No image assets needed beyond optional background diagram. | **G-SQ-9**: Optional per-item thumbnails not generated (LOW priority — text-based works). |
| 6 | Blueprint | PARTIAL | Blueprint has `sequenceConfig` field. | **G-SQ-10** (CRITICAL): `assemble_blueprint_impl` extracts `sequence_config` from game_design mechanics, but upstream never populates `items[]` or `correctOrder[]`. Blueprint `sequenceConfig` is always empty or null. |
| 7 | Frontend UI | FULL | `SequenceBuilder.tsx` with dnd-kit sortable, drag-to-reorder, binary/percentage scoring. | **G-SQ-11**: Has fallback: if no `sequenceConfig`, derives items from `blueprint.labels` with alphabetical "correct" order. This produces a working but educationally meaningless game. **G-SQ-12**: Logs console.warn but no user-visible error. |
| 8 | Frontend State | LOCAL | State managed inside `SequenceBuilder` via `useState`. | **G-SQ-13** (CRITICAL): Parent game controller cannot observe sequencing progress. `advanceToNextTask()` cannot detect completion. Time limits not enforceable. **G-SQ-14**: No persistence of partial sequence across page reloads. **G-SQ-15**: Scoring computed inside component, bubbled via `onComplete` callback — wiring is fragile. |

**Total gaps: 15 (3 CRITICAL, 4 HIGH, 5 MEDIUM, 3 LOW)**

**Root cause:** Sequencing data should flow from `domain_knowledge.sequence_flow_data` → `game_designer_v3` (structure items) → `scene_architect_v3` (assign to scene) → blueprint. Currently no agent in this chain transforms sequence_flow_data into the `SequenceConfig` format the frontend expects.

---

### 5. description_matching

**End-to-End Status: BROKEN** — Frontend component exists but state is disconnected. More critically, **no agent generates functional descriptions** that differ from zone labels. A description_matching game needs descriptions like "Pumps blood to the lungs" mapped to zones like "Right Ventricle" — no agent produces these.

| # | Stage | Status | Details | Gaps |
|---|---|---|---|---|
| 1 | DK Retrieval | GAP | No description-specific data retrieved. | **G-DM-1** (CRITICAL): No tool or prompt to retrieve functional descriptions per label. Domain knowledge gets labels ("Right Ventricle") but NOT descriptions ("Pumps deoxygenated blood to lungs via pulmonary artery"). **G-DM-2**: No distractor descriptions retrieved. **G-DM-3**: `content_characteristics.needs_comparison` flag exists but not used to trigger description retrieval. |
| 2 | Game Design | PARTIAL | `DescriptionMatchDesign` schema exists with `sub_mode`, `descriptions`, `instruction_text`. | **G-DM-4**: `GameDesignV3Slim` has no description_match_config at slim stage. **G-DM-5**: Full `DescriptionMatchDesign` exists but game_designer_v3 never populates it. **G-DM-6**: `validate_design_impl()` doesn't validate description_matching has descriptions. |
| 3 | Scene Arch | PARTIAL | System prompt documents `mechanic_data: {descriptions: [{zone_label, description}]}`. | **G-DM-7**: No tool to generate functional descriptions from zone labels + domain knowledge. Agent must generate descriptions purely from LLM reasoning without structured support. **G-DM-8**: `validate_scene_spec` doesn't validate descriptions present for description_matching mechanic. |
| 4 | Interaction | BROKEN | `get_scoring_templates("description_matching")` returns standard scoring. Generic feedback. | **G-DM-9** (CRITICAL): No description-specific scoring (per-description match points, partial credit for near-matches). **G-DM-10**: No per-description feedback messages. **G-DM-11**: No sub_mode configuration generated (click_zone vs drag_description vs multiple_choice). |
| 5 | Asset Gen | REUSE | Reuses drag_drop zones. No description-specific assets needed. | **G-DM-12**: No `generate_functional_descriptions` tool exists. Cannot generate "This structure pumps blood..." descriptions from zone labels. |
| 6 | Blueprint | PARTIAL | Blueprint mechanic config extracted if present. Zone `description` field exists. | **G-DM-13** (CRITICAL): Blueprint `mechanic_config` for description_matching is untyped `Dict[str, Any]`. No schema enforces required fields (`descriptions`, `matching_mode`, `shuffle_descriptions`). **G-DM-14**: Zone `description` field populated from scene_spec but contains position descriptions ("located in upper right"), not functional descriptions needed for matching. |
| 7 | Frontend UI | PARTIAL | `DescriptionMatcher.tsx` exists. Supports 3 sub-modes. | **G-DM-15**: Component content not fully verified. Renders description cards and zone targets but matching logic unclear. **G-DM-16**: No fallback to drag_drop when description data missing (unlike other mechanics that log warning + fall back). |
| 8 | Frontend State | DISCONNECTED | `DescriptionMatchingState` type defined. `initializeDescriptionMatching()` and `recordDescriptionMatch()` actions exist. | **G-DM-17** (CRITICAL): `recordDescriptionMatch()` records a single match but multi-descriptor progress tracking unclear. **G-DM-18**: No completion detection in `checkModeTransition()` for description_matching — game never auto-completes. **G-DM-19**: No persistence of partial matches. **G-DM-20**: Scoring not wired to centralized scoring system. |

**Total gaps: 20 (4 CRITICAL, 6 HIGH, 6 MEDIUM, 4 LOW)**

**Root cause:** Description_matching requires a fundamentally different data type — functional descriptions of what structures DO, not what they ARE. No agent in the pipeline is equipped to generate these. Needs: `generate_functional_descriptions` tool (LLM with domain knowledge context).

---

### 6. hierarchy (Cross-Cutting Modifier)

**End-to-End Status: FUNCTIONAL as modifier on drag_drop** — Works when combined with drag_drop to create progressive reveal games. Not a standalone mechanic.

| # | Stage | Status | Details | Gaps |
|---|---|---|---|---|
| 1 | DK Retrieval | FULL | `hierarchical_relationships` retrieved with parent-child data. | None |
| 2 | Game Design | FULL | `HierarchySpec` with `enabled`, `strategy`, `groups[]`. `HierarchyGroup` with `parent`, `children`, `reveal_trigger`. | **G-HI-1**: No `max_depth` field despite being referenced in interaction_patterns.py config. **G-HI-2**: Validation only checks label existence — no cycle detection (A→B→A), no depth limit enforcement, no parent-child exclusivity check. |
| 3 | Scene Arch | FULL | `zone_hierarchy[]` in SceneSpecV3 with parent-child mappings. | **G-HI-3**: System prompt doesn't document `hover_reveal` trigger behavior (frontend type exists but no implementation). |
| 4 | Interaction | N/A | Hierarchy modifies underlying mechanic's scoring, doesn't have own scoring. | None |
| 5 | Asset Gen | PARTIAL | Zone detection produces flat zones. Parent zones contain children semantically but not spatially enforced. | **G-HI-4**: No spatial containment validation — child zone (x,y) may be outside parent zone boundary. **G-HI-5**: No visual hierarchy indicators generated (nesting borders, level colors are frontend-only). |
| 6 | Blueprint | FULL | Zones carry `parentZoneId`, `hierarchyLevel`, `childZoneIds`. `zoneGroups` array populated. | **G-HI-6**: No progressive reveal config in blueprint (just zone structure). Frontend infers reveal from `complete_parent` trigger but blueprint doesn't explicitly specify reveal order. |
| 7 | Frontend UI | PARTIAL | `HierarchyController.tsx` handles expand/collapse with drag-drop integration. | **G-HI-7**: `hover_reveal` trigger type defined but NOT implemented (only `complete_parent` works). **G-HI-8**: `click_expand` may not work reliably when combined with drag_drop (click vs drag ambiguity). |
| 8 | Frontend State | PARTIAL | `HierarchyState` tracks `expandedGroups`, `completedParentZones`. `updateHierarchyState()` action. | **G-HI-9**: `updateVisibleZones()` builds mutex map but mutex/sequence/before/after constraint evaluation is incomplete — only parent-child "after" constraint works. **G-HI-10**: Transition between hierarchy levels not fully tested with multi-scene games. |

**Classification problem:**
- **G-HI-11** (MEDIUM): Listed in `VALID_MECHANIC_TYPES` and `InteractionMode` enum as standalone mechanic. Should be cross-cutting modifier on `SceneTask` level. Confuses game_planner mechanic selection.

**Total gaps: 11 (0 CRITICAL, 3 HIGH, 5 MEDIUM, 3 LOW)**

---

## Cross-Cutting Issues (Affecting Multiple Mechanics)

### CC-1: canonical_labels State Routing Bug (CRITICAL)

**File:** `backend/app/agents/domain_knowledge_retriever.py` lines 521-533
**Impact:** All V3 mechanics

`domain_knowledge_retriever` writes `canonical_labels` ONLY inside nested `domain_knowledge` dict. V3 agents read `state.get("canonical_labels", [])` at top level, which is always `[]`.

**Affected readers:**
- `game_designer_v3.py:117` — `state.get("canonical_labels", [])`
- `scene_architect_v3.py:102` — `state.get("canonical_labels", [])`
- `asset_generator_v3.py:95` — `state.get("canonical_labels", [])`
- `v3_context.py:34` — `state.get("canonical_labels", [])`

**Why it still works:** Domain knowledge dict (containing labels) is passed as full JSON text to LLM prompts. But explicit `canonical_labels` variable is always empty, defeating its purpose as structured data.

### CC-2: GameDesignV3Slim Has No Mechanic-Specific Configs (HIGH)

**File:** `backend/app/agents/schemas/game_design_v3.py` lines 740-751
**Impact:** click_to_identify, trace_path, sequencing, description_matching

`SlimMechanicRef` contains ONLY `type: str`. No `path_config`, `click_config`, `sequence_config`, `description_match_config`. Full `MechanicDesign` with these fields exists in the non-slim schema but `game_designer_v3` only outputs `GameDesignV3Slim`.

**Consequence:** Mechanic-specific configuration is never generated at design time. Downstream agents (scene_architect, interaction_designer) have no structured config to work with.

### CC-3: interaction_designer_v3 Doesn't Generate Mechanic Content (CRITICAL)

**File:** `backend/app/agents/interaction_designer_v3.py`
**Impact:** click_to_identify, trace_path, sequencing, description_matching

The agent's responsibility is limited to scoring strategy + generic feedback. It does NOT generate:
- Identification prompts (click_to_identify)
- Waypoint data (trace_path)
- Sequence items (sequencing)
- Functional descriptions (description_matching)

No tool in its toolset can produce this data. It assumes upstream agents already populated it — but they don't.

### CC-4: Validators Don't Check Mechanic-Specific Fields (HIGH)

**Files:** `design_validator`, `scene_validator.py`, `interaction_validator.py`
**Impact:** All non-drag_drop mechanics

All three V3 validators check structural requirements (title exists, scenes exist, mechanics have valid types) but NONE validate mechanic-specific content:
- click_to_identify with zero prompts passes validation
- trace_path with zero waypoints passes validation
- sequencing with zero sequence items passes validation
- description_matching with zero descriptions passes validation

### CC-5: Blueprint mechanic_config is Untyped Dict (HIGH)

**File:** `backend/app/agents/schemas/blueprint_schemas.py`
**Impact:** All mechanics

`IDMechanic.config` is `Optional[Dict[str, Any]]`. No discriminated union or typed schema per mechanic type. Silent misconfiguration is possible — agents can produce config that frontend cannot interpret.

### CC-6: No Mechanic-Aware Asset Validation (MEDIUM)

**File:** `backend/app/tools/asset_generator_tools.py` (`submit_assets`)
**Impact:** trace_path, sequencing, description_matching, hierarchy

`submit_assets` validates zone count and image presence but NOT mechanic-specific requirements:
- trace_path scenes: no check for waypoint coordinates
- sequencing scenes: no check for sequence items
- description_matching scenes: no check for descriptions
- hierarchy scenes: no check for parent-child zone containment

### CC-7: Multi-Mode Task Transitions Fragile (MEDIUM)

**Files:** `useLabelDiagramState.ts`, `index.tsx`
**Impact:** All multi-mechanic scenes

`advanceToNextTask()` relies on `isComplete` flag, which is only reliably set by:
- drag_drop (via `placedLabels` count)
- click_to_identify (via `HotspotManager.onAllComplete`)

For locally-stated mechanics (sequencing, description_matching), task completion cannot be detected by the parent game controller.

### CC-8: score Calculation Bug in advanceToNextTask (MEDIUM)

**File:** `useLabelDiagramState.ts` line ~1026
**Impact:** All mechanics in multi-task scenes

`max_score` calculated as `placedLabels.filter(p => p.isCorrect).length * basePointsPerZone` — only counts correctly placed labels, not all possible labels. Should be `totalLabels * basePointsPerZone`.

### CC-9: Time-Based Transitions Not Implemented (MEDIUM)

**File:** `useLabelDiagramState.ts`
**Impact:** timed_challenge, any mechanic with time_elapsed trigger

`ModeTransitionTrigger` includes `time_elapsed` but `checkModeTransition()` has no timer integration. Comment says "handled by component" but no component implements it.

### CC-10: Temporal Constraints Incomplete (MEDIUM)

**File:** `useLabelDiagramState.ts`
**Impact:** hierarchy, any mechanic using progressive reveal

`TemporalConstraint` types defined: before, after, mutex, concurrent, sequence. Only "after" (parent-child reveal) is implemented. mutex, before, concurrent, sequence constraints are defined in types but logic is incomplete in `updateVisibleZones()`.

### CC-11: scene_architect_v3 get_zone_layout_guidance Uses Flash Model (MEDIUM)

**File:** `backend/app/tools/scene_architect_tools.py` line ~81
**Impact:** All mechanics (zone quality)

`get_zone_layout_guidance` calls `llm.generate_json(..., model="gemini-2.5-flash")` while the agent itself requires `gemini-2.5-pro`. Zone guidance may be lower quality or malformed.

### CC-12: format_patterns_for_prompt Exposes Experimental Mechanics (LOW)

**File:** `backend/app/tools/game_design_v3_tools.py`
**Impact:** Game design quality

`format_patterns_for_prompt()` includes ALL patterns (complete, partial, experimental, missing). Agent sees descriptions of unimplemented features like `phet_simulation` and `parameter_discovery`, potentially proposing them.

### CC-13: Bloom's Level Silently Defaults (LOW)

**File:** `backend/app/tools/game_design_v3_tools.py` lines 78-80
**Impact:** All mechanics

Invalid Bloom's level silently defaults to "understand" with no warning logged. Could mask data quality issues.

### CC-14: parse_final_result Strategy 3 Not Implemented (LOW)

**File:** `backend/app/agents/scene_architect_v3.py`
**Impact:** Resilience on scene_architect failures

Third fallback strategy (reconstruct from tool results + game_design) is documented in comments but not implemented. If strategies 1 & 2 fail, agent produces no output.

---

## Complete Prioritized Gap List

### CRITICAL (13 gaps — mechanic non-functional)

| # | ID | Gap | File(s) | Mechanic |
|---|---|---|---|---|
| 1 | G-CI-6 | No agent generates `identificationPrompts` for click_to_identify | interaction_designer_v3.py | click_to_identify |
| 2 | G-TP-12 | No `generate_waypoints` tool — cannot map flow data to image coordinates | asset_generator_tools.py | trace_path |
| 3 | G-TP-13 | No `generate_path_connections` tool — cannot define edges between waypoints | asset_generator_tools.py | trace_path |
| 4 | G-TP-9 | No waypoint-specific scoring or path validation data generated | interaction_designer_v3.py | trace_path |
| 5 | G-TP-10 | No path validation config (tolerance, snap distance, deviations) | interaction_designer_v3.py | trace_path |
| 6 | G-SQ-7 | No sequence-specific scoring generated (per-item, order sensitivity) | interaction_designer_v3.py | sequencing |
| 7 | G-SQ-10 | Blueprint `sequenceConfig` always empty — no items or correctOrder | blueprint_assembler_tools.py | sequencing |
| 8 | G-SQ-13 | Sequencing state not in centralized store — task transitions broken | useLabelDiagramState.ts | sequencing |
| 9 | G-DM-1 | No tool retrieves functional descriptions per label | domain_knowledge_retriever.py | description_matching |
| 10 | G-DM-9 | No description-specific scoring generated | interaction_designer_v3.py | description_matching |
| 11 | G-DM-13 | Blueprint mechanic_config for description_matching is untyped Dict | blueprint_assembler_tools.py | description_matching |
| 12 | G-DM-17 | description_matching completion detection broken — game never auto-completes | useLabelDiagramState.ts | description_matching |
| 13 | CC-1 | canonical_labels at top-level state always empty in V3 | domain_knowledge_retriever.py | All |

### HIGH (16 gaps — significant degradation or data loss)

| # | ID | Gap | File(s) | Mechanic |
|---|---|---|---|---|
| 14 | CC-2 | GameDesignV3Slim has no mechanic-specific configs | game_design_v3.py | All non-drag_drop |
| 15 | CC-3 | interaction_designer_v3 doesn't generate mechanic content | interaction_designer_v3.py | All non-drag_drop |
| 16 | CC-4 | Validators don't check mechanic-specific fields | *_validator.py | All non-drag_drop |
| 17 | CC-5 | Blueprint mechanic_config is untyped Dict[str, Any] | blueprint_schemas.py | All |
| 18 | G-CI-2 | Slim design has no click_config or prompts | game_design_v3.py | click_to_identify |
| 19 | G-CI-9 | Blueprint identificationPrompts always empty | blueprint_assembler_tools.py | click_to_identify |
| 20 | G-TP-6 | No tool verifies waypoints map to zone labels | scene_architect_tools.py | trace_path |
| 21 | G-TP-14 | No path overlay generation (SVG, canvas coordinates) | asset_generator_tools.py | trace_path |
| 22 | G-TP-16 | Blueprint paths field always empty or text-only | blueprint_assembler_tools.py | trace_path |
| 23 | G-SQ-5 | No tool to generate sequence items from flow data | scene_architect_tools.py | sequencing |
| 24 | G-DM-7 | No tool to generate functional descriptions | scene_architect_tools.py | description_matching |
| 25 | G-DM-12 | No `generate_functional_descriptions` tool in asset gen | asset_generator_tools.py | description_matching |
| 26 | G-DM-14 | Zone descriptions are positional, not functional | blueprint_assembler_tools.py | description_matching |
| 27 | G-DM-18 | No completion detection for description_matching | useLabelDiagramState.ts | description_matching |
| 28 | G-DD-4 | Zone detection may miss labels — placeholder grid fallback | asset_generator_tools.py | drag_drop |
| 29 | G-HI-4 | No spatial containment validation for hierarchy zones | asset_generator_tools.py | hierarchy |

### MEDIUM (15 gaps — edge cases, persistence, observability broken)

| # | ID | Gap | File(s) | Mechanic |
|---|---|---|---|---|
| 30 | CC-6 | No mechanic-aware asset validation in submit_assets | asset_generator_tools.py | All |
| 31 | CC-7 | Multi-mode task transitions fragile for local-state mechanics | useLabelDiagramState.ts | Multi-mechanic |
| 32 | CC-8 | max_score bug in advanceToNextTask | useLabelDiagramState.ts | Multi-task |
| 33 | CC-9 | Time-based transitions not implemented | useLabelDiagramState.ts | timed_challenge |
| 34 | CC-10 | Temporal constraints (mutex, sequence, before) incomplete | useLabelDiagramState.ts | hierarchy |
| 35 | CC-11 | get_zone_layout_guidance uses Flash model | scene_architect_tools.py | All |
| 36 | G-HI-11 | Hierarchy classified as mechanic in enum | game_design_v3.py, types.ts | hierarchy |
| 37 | G-CI-5 | validate_scene_spec doesn't check click prompts | scene_spec_v3.py | click_to_identify |
| 38 | G-TP-7 | validate_scene_spec doesn't check waypoints | scene_spec_v3.py | trace_path |
| 39 | G-SQ-6 | validate_scene_spec doesn't check sequence items | scene_spec_v3.py | sequencing |
| 40 | G-DM-8 | validate_scene_spec doesn't check descriptions | scene_spec_v3.py | description_matching |
| 41 | G-SQ-14 | No persistence of partial sequence progress | SequenceBuilder.tsx | sequencing |
| 42 | G-DM-19 | No persistence of partial description matches | DescriptionMatcher.tsx | description_matching |
| 43 | G-DM-20 | Description matching scoring not wired to central scoring | useLabelDiagramState.ts | description_matching |
| 44 | G-HI-2 | No hierarchy cycle detection or depth limit enforcement | game_design_v3.py | hierarchy |

### LOW (8 gaps — cosmetic, architectural, or no immediate user impact)

| # | ID | Gap | File(s) | Mechanic |
|---|---|---|---|---|
| 45 | CC-12 | format_patterns_for_prompt exposes experimental mechanics | game_design_v3_tools.py | All |
| 46 | CC-13 | Bloom's level silently defaults to "understand" | game_design_v3_tools.py | All |
| 47 | CC-14 | parse_final_result strategy 3 not implemented | scene_architect_v3.py | All |
| 48 | G-DD-2 | No distractor label count limit | game_design_v3.py | drag_drop |
| 49 | G-DD-5 | Image search may return labeled diagrams | asset_generator_tools.py | drag_drop |
| 50 | G-DD-6 | Coordinates not clamped at assembly time | blueprint_assembler_tools.py | drag_drop |
| 51 | G-HI-3 | hover_reveal not documented in system prompt | scene_architect_v3.py | hierarchy |
| 52 | G-HI-7 | hover_reveal trigger type defined but not implemented | HierarchyController.tsx | hierarchy |

---

## Severity Definitions

| Severity | Count | Definition |
|---|---|---|
| **CRITICAL** | 13 | Mechanic is non-functional end-to-end. User interaction loop does not close. |
| **HIGH** | 16 | Mechanic has structural gaps causing significant degradation or silent data loss. |
| **MEDIUM** | 15 | Mechanic works in primary path but edge cases, persistence, or validation broken. |
| **LOW** | 8 | Cosmetic or architectural. No immediate user-facing impact. |

---

## Recommendations (Ordered by Impact)

### Phase 1: Unblock Non-drag_drop Mechanics (CRITICAL fixes)

1. **Fix canonical_labels routing** — In `domain_knowledge_retriever.py`, add `"canonical_labels": canonical_labels` to top-level return dict. One-line fix, unblocks all V3 agents.

2. **Add mechanic content generation tools** — The single most impactful change. Add to `interaction_designer_v3` (or create new tools in scene_architect_v3):
   - `generate_identification_prompts(zone_labels, subject, difficulty)` → for click_to_identify
   - `generate_sequence_items(flow_data, subject)` → for sequencing
   - `generate_functional_descriptions(labels, subject, blooms_level)` → for description_matching

3. **Add trace_path asset tools** — In `asset_generator_v3`:
   - `generate_waypoints(image_path, flow_items, image_description)` → vision model locates flow items on image
   - `generate_path_connections(waypoints, flow_type)` → deterministic for linear/cyclic

4. **Wire description_matching state** — Add `MATCH_DESCRIPTION` completion detection in `checkModeTransition()`. Wire `DescriptionMatcher` callbacks to store dispatch.

5. **Lift sequencing state** — Move from `SequenceBuilder` local `useState` into `useLabelDiagramState` centralized store.

### Phase 2: Validation & Robustness (HIGH fixes)

6. **Add mechanic-specific validation** — In all three validators, check mechanic-required fields:
   - click_to_identify: prompts non-empty
   - trace_path: waypoints with coordinates
   - sequencing: items with correct_order
   - description_matching: descriptions per zone

7. **Type blueprint mechanic_config** — Replace `Dict[str, Any]` with discriminated union keyed on mechanic type.

8. **Populate GameDesignV3Slim with mechanic configs** — Either expand SlimMechanicRef to include optional configs, or add a separate `mechanic_configs` dict on SlimSceneDesign.

### Phase 3: Quality & Architecture (MEDIUM fixes)

9. **Reclassify hierarchy** — Remove from `VALID_MECHANIC_TYPES` and `InteractionMode`. Add as `hierarchy_config` on SceneTask.

10. **Fix advanceToNextTask scoring** — Use all possible labels × basePointsPerZone, not just correctly placed.

11. **Add mechanic-aware asset validation** — In `submit_assets`, validate per-mechanic requirements.

12. **Implement time-based transitions** — Add timer integration in `useLabelDiagramState`.

13. **Complete temporal constraints** — Implement mutex, sequence, before constraints in `updateVisibleZones()`.

### Phase 4: Polish (LOW fixes)

14. **Fix zone layout guidance model** — Change from Flash to Pro.
15. **Add distractor label limit** — Cap at reasonable number (10-15).
16. **Implement hover_reveal** — Add hover handler in HierarchyController.
17. **Filter experimental patterns** — Don't expose EXPERIMENTAL mechanics to game designer agent.
