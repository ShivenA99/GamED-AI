# Cursor Rules for GamED.AI v2

## Project Context
This is a multi-agent LangGraph pipeline for educational game generation. The system uses observability tracking for all agents.

## Key Rules

### When Adding a New Agent
1. Add input/output keys to `backend/app/agents/instrumentation.py` in BOTH `extract_input_keys()` and `extract_output_keys()`
2. Add agent metadata to `frontend/src/components/pipeline/PipelineView.tsx` in `AGENT_METADATA`
3. Add agent to `GRAPH_LAYOUT` and `edgeDefinitions` in the same file
4. Register in `backend/app/agents/graph.py` using `wrap_agent_with_instrumentation()`
5. Optionally add custom output renderer to `frontend/src/components/pipeline/StagePanel.tsx`

### Agent Function Pattern
```python
async def my_agent(state: AgentState, ctx: Optional[InstrumentedAgentContext] = None) -> dict:
    # Extract inputs, do work, track metrics, return state update
    if ctx:
        ctx.set_llm_metrics(model=..., prompt_tokens=..., completion_tokens=...)
    return {"output_key": result}
```

### Always Use
- `PYTHONPATH=.` prefix for all Python scripts
- Type hints for all function parameters and returns
- Async/await for I/O operations
- Named exports in TypeScript
- Utility classes from globals.css (card, badge-*, btn-*)

### Never Do
- Use `any` type in TypeScript without justification
- Create agents without telemetry registration
- Commit without running `npx tsc --noEmit` (frontend)
- Run backend scripts without activating venv

### File Locations
| Purpose | Path |
|---------|------|
| Agent code | `backend/app/agents/` |
| Agent schemas | `backend/app/agents/schemas/` |
| Instrumentation | `backend/app/agents/instrumentation.py` |
| Graph definition | `backend/app/agents/graph.py` |
| Pipeline UI | `frontend/src/components/pipeline/` |
| Agent metadata | `frontend/src/components/pipeline/PipelineView.tsx` |
| Output renderers | `frontend/src/components/pipeline/StagePanel.tsx` |

### Quick Commands
```bash
# Backend
cd backend && source venv/bin/activate && PYTHONPATH=. uvicorn app.main:app --reload --port 8000

# Frontend
cd frontend && npm run dev

# TypeScript check
cd frontend && npx tsc --noEmit

# Kill ports
lsof -ti:8000,3000 | xargs kill -9
```

### Environment
- GROQ_API_KEY (free) or OPENAI_API_KEY or ANTHROPIC_API_KEY
- AGENT_CONFIG_PRESET=groq_free
- SERPER_API_KEY (for label diagram)
